# 教师注册报错修复说明

## 问题描述

**错误现象**：
教师注册时填写班级名称"高三2班"，报错：
```
Expected one result (or null) to be returned by selectOne(), but found: 2
```

## 根本原因

在 `AuthController.java` 的 `register()` 方法中，使用 `selectOne()` 查询学校时，数据库中存在2条相同的"云南大学"记录：

```sql
SELECT id, school_name FROM school WHERE school_name = '云南大学' AND deleted = 0;
-- 结果：
-- id=3, school_name=云南大学
-- id=4, school_name=云南大学
```

导致 `schoolMapper.selectOne(schoolWrapper)` 抛出异常。

## 修复方案

### 1. 代码修复（防御性编程）

修改 `AuthController.java`，在查询时添加 `LIMIT 1`：

**文件**: `E:\shixun\backend\src\main\java\com\education\platform\controller\AuthController.java`

**修改位置**: 第145行和第169行

```java
// 修复前
schoolWrapper.eq(School::getSchoolName, request.getSchoolName());
School existingSchool = schoolMapper.selectOne(schoolWrapper);

// 修复后
schoolWrapper.eq(School::getSchoolName, request.getSchoolName());
schoolWrapper.last("LIMIT 1");  // 防止返回多条记录
School existingSchool = schoolMapper.selectOne(schoolWrapper);
```

同样修复班级查询：
```java
// 修复前
classWrapper.eq(Class::getSchoolId, schoolId);
classWrapper.eq(Class::getClassName, request.getClassName());
Class existingClass = classMapper.selectOne(classWrapper);

// 修复后
classWrapper.eq(Class::getSchoolId, schoolId);
classWrapper.eq(Class::getClassName, request.getClassName());
classWrapper.last("LIMIT 1");  // 防止返回多条记录
Class existingClass = classMapper.selectOne(classWrapper);
```

### 2. 数据修复（清理重复数据）

**执行的SQL操作**：
```sql
-- 1. 将学校ID=4的用户更新为学校ID=3
UPDATE user SET school_id = 3 WHERE school_id = 4;

-- 2. 删除重复的学校记录
DELETE FROM school WHERE id = 4;
```

**数据变更前后对比**：

| 表名 | 变更前 | 变更后 |
|------|--------|--------|
| school | id=3:云南大学<br>id=4:云南大学 | id=3:云南大学 |
| user | 123→3, xuesheng→3, jiaoshi→4 | 123→3, xuesheng→3, jiaoshi→3 |

## 修复验证

### 数据库状态验证
```sql
-- 验证学校表
SELECT * FROM school WHERE school_name = '云南大学';
-- 结果：仅1条记录，id=3

-- 验证用户表
SELECT id, username, school_id FROM user WHERE school_id = 3;
-- 结果：3个用户都正确关联到学校id=3
```

### 代码编译验证
```
[INFO] BUILD SUCCESS
[INFO] Compiling 131 source files
```

## 预防措施

1. **数据库约束**：建议为 `school_name` 字段添加唯一约束
   ```sql
   ALTER TABLE school ADD UNIQUE KEY uk_school_name (school_name);
   ```

2. **代码防御**：所有使用 `selectOne()` 的地方都应考虑添加 `LIMIT 1`

3. **数据清理**：定期检查重复数据

## 测试建议

1. 使用用户名"123"或"xuesheng"或"jiaoshi"登录
2. 尝试注册新用户，填写"云南大学"作为学校名称
3. 应该能正常注册，不会报错

## 相关文件

- `E:\shixun\backend\src\main\java\com\education\platform\controller\AuthController.java` (已修改)
- 数据库：school表 (已清理重复数据)

## 修复完成时间
2026-01-10 16:40