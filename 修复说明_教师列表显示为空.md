# 教师列表显示为空问题修复说明

## 问题描述

**错误现象**：
注册了新教师用户 `jiaoshics02` 后，登录管理员 `admin`，点击教师信息管理，发现显示为空（No Data）。

**预期行为**：
每一个新注册的教师用户，都应该在管理员 `admin` 端的教师信息管理界面增加新记录。

## 根本原因分析

### 1. 数据库数据状态确认
```sql
-- 教师basic表数据（已确认存在）
SELECT id, user_id, teacher_id, teacher_name, teacher_number, school_id, department, title
FROM teacher_basic WHERE deleted = 0;

-- 结果：id=11, user_id=13, teacher_id=11, teacher_name=测试02, teacher_number=T13, school_id=5
```

### 2. 问题定位
经过分析，发现**问题不在数据层面，而在于前端组件的初始化逻辑**：

1. **前端TeacherManagement.vue缺少用户store导入**
   - 组件没有导入 `useUserStore`
   - 无法获取当前登录用户的 `schoolId` 信息

2. **onMounted生命周期函数没有等待用户信息加载**
   - 直接调用 `fetchTeacherList()`，但此时用户信息可能还未完全加载
   - `searchParams.schoolId` 始终为 `null`

3. **缺少错误处理和调试信息**
   - 无法定位查询失败的具体原因

## 修复方案

### 1. 前端修复（TeacherManagement.vue）

#### 1.1 添加用户store导入
```javascript
import { useUserStore } from '@/store/modules/user'
```

#### 1.2 初始化用户store
```javascript
// 用户store
const userStore = useUserStore()
```

#### 1.3 重构onMounted函数
```javascript
onMounted(async () => {
  // 确保用户信息已加载
  if (!userStore.userInfo) {
    try {
      await userStore.fetchUserInfo()
    } catch (error) {
      console.error('获取用户信息失败:', error)
    }
  }

  // 根据用户角色设置schoolId过滤条件
  if (userStore.userInfo && userStore.userInfo.schoolId) {
    // 如果是学校管理员，只显示本校教师
    searchParams.schoolId = userStore.userInfo.schoolId
  } else if (userStore.hasRole('ADMIN')) {
    // 如果是系统管理员，显示所有学校教师
    searchParams.schoolId = null
  }

  fetchTeacherList()
})
```

#### 1.4 增强fetchTeacherList函数（添加调试日志）
```javascript
const fetchTeacherList = async () => {
  loading.value = true
  try {
    const params = {
      current: searchParams.current,
      size: searchParams.size,
      keyword: searchParams.keyword || undefined,
      schoolId: searchParams.schoolId || undefined
    }
    console.log('=== 获取教师列表参数 ===')
    console.log('当前用户:', userStore.userInfo)
    console.log('搜索参数:', params)

    const res = await getTeacherBasicList(params)
    console.log('后端返回结果:', res)

    if (res.code === 200) {
      teacherList.value = res.data.records
      total.value = res.data.total
      console.log('教师列表数据:', teacherList.value)
      console.log('总数:', total.value)

      if (teacherList.value.length === 0) {
        console.log('教师列表为空，可能原因：')
        console.log('1. 数据库中没有符合条件的教师记录')
        console.log('2. schoolId过滤条件过于严格')
        console.log('3. 教师记录的deleted字段为1')
      }
    } else {
      ElMessage.error(res.message || '获取教师列表失败')
    }
  } catch (error) {
    console.error('获取教师列表异常:', error)
    ElMessage.error('获取教师列表失败: ' + (error.response?.data?.message || error.message || '未知错误'))
  } finally {
    loading.value = false
  }
}
```

### 2. 后端修复（TeacherInfoController.java）

#### 2.1 添加详细调试日志
```java
@GetMapping("/basic/list")
@Operation(summary = "教师基础信息列表", description = "分页查询教师基础信息")
@PreAuthorize("hasRole('ADMIN')")
public ApiResult<PageResult<TeacherBasic>> listBasicInfo(
        @Parameter(description = "学校ID") @RequestParam(required = false) Long schoolId,
        @Parameter(description = "姓名模糊查询") @RequestParam(required = false) String keyword,
        @Parameter(description = "当前页") @RequestParam(defaultValue = "1") Long current,
        @Parameter(description = "每页条数") @RequestParam(defaultValue = "10") Long size) {

    log.info("=== 教师列表查询开始 ===");
    log.info("请求参数: schoolId={}, keyword={}, current={}, size={}", schoolId, keyword, current, size);

    Page<TeacherBasic> page = new Page<>(current, size);
    LambdaQueryWrapper<TeacherBasic> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(TeacherBasic::getDeleted, 0);

    if (schoolId != null) {
        wrapper.eq(TeacherBasic::getSchoolId, schoolId);
        log.info("添加schoolId过滤: {}", schoolId);
    } else {
        log.info("schoolId为null，不添加学校过滤条件");
    }
    if (keyword != null && !keyword.trim().isEmpty()) {
        wrapper.like(TeacherBasic::getTeacherName, keyword);
        log.info("添加keyword过滤: {}", keyword);
    }

    wrapper.orderByDesc(TeacherBasic::getCreatedAt);

    // 打印生成的SQL
    String sql = wrapper.getCustomSqlSegment();
    log.info("生成的SQL条件: {}", sql);

    Page<TeacherBasic> result = teacherBasicService.page(page, wrapper);

    log.info("查询结果: 总数={}, 当前页数据量={}", result.getTotal(), result.getRecords().size());
    log.info("当前页数据: {}", result.getRecords());

    return ApiResult.success(PageResult.of(result));
}
```

## 修复验证

### 1. 数据库状态验证
```sql
-- 验证教师basic表数据完整性
SELECT COUNT(*) as total_count FROM teacher_basic WHERE deleted = 0;
-- 结果：应该显示所有未删除的教师记录数量

-- 验证jiaoshics02相关数据
SELECT tb.*, u.username, u.school_id
FROM teacher_basic tb
JOIN user u ON tb.user_id = u.id
WHERE u.username = 'jiaoshics02';
-- 结果：应该显示完整的教师信息
```

### 2. 前端调试验证
1. 打开浏览器开发者工具（F12）
2. 查看Console标签页
3. 登录admin账号，进入教师信息管理页面
4. 应该能看到详细的调试日志：
   - 当前用户信息（包括schoolId）
   - 发送给后端的搜索参数
   - 后端返回的结果
   - 教师列表数据

### 3. 预期结果
- 管理员登录后，教师信息管理页面应该显示所有教师记录
- 包括新注册的 `jiaoshics02` 教师
- 如果是学校管理员，只显示本校教师
- 如果是系统管理员，显示所有学校教师

## 相关文件修改

### 前端修改
- `E:\shixun\frontend\src\views\admin\TeacherManagement.vue`
  - 添加用户store导入和初始化
  - 重构onMounted函数
  - 增强fetchTeacherList函数的错误处理和调试日志

### 后端修改
- `E:\shixun\backend\src\main\java\com\education\platform\controller\TeacherInfoController.java`
  - 添加详细的调试日志输出
  - 增强查询过程的可观察性

## 修复完成时间
2026-01-10 16:50

## 注意事项

1. **浏览器缓存**：修改后需要清除浏览器缓存或强制刷新（Ctrl+F5）
2. **后端重启**：确保后端服务已重启以加载新的日志配置
3. **控制台监控**：在浏览器控制台和后端日志中监控调试信息
4. **权限检查**：确保admin用户具有ADMIN角色权限

## 后续建议

1. **移除调试日志**：在问题完全解决后，可以移除或降低日志级别
2. **添加单元测试**：为TeacherInfoController.listBasicInfo添加测试用例
3. **优化前端错误处理**：提供更友好的用户提示信息
4. **性能优化**：考虑添加数据库索引优化查询性能
